{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
{{ block.super }}
<style>
  .analytics-container {
    padding: 20px;
  }
  .stats-card {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
    background-color: #fff;
  }
  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .date-filter {
    margin-bottom: 20px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-box {
    background-color: #f9f9f9;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
  }
  .stat-title {
    color: #666;
    font-size: 16px;
    margin-bottom: 10px;
  }
  .stat-value {
    font-size: 28px;
    font-weight: bold;
  }
  .stat-meta {
    color: #888;
    font-size: 12px;
    margin-top: 5px;
  }
  .chart-container {
    height: 300px;
    margin-bottom: 30px;
  }
  .table-container {
    margin-bottom: 30px;
  }
  table.data-table {
    width: 100%;
    border-collapse: collapse;
  }
  .data-table th, .data-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  .data-table th {
    background-color: #f2f2f2;
  }
  .data-table tr:hover {
    background-color: #f5f5f5;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div id="content-main" class="analytics-container">
  <div class="stats-header">
    <h1>Forum Analytics Dashboard</h1>
    <div class="date-filter">
      <form method="get" action="">
        <label for="days">Time period:</label>
        <select name="days" id="days" onchange="this.form.submit()">
          <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
          <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
          <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
          <option value="365" {% if days == 365 %}selected{% endif %}>Last year</option>
        </select>
      </form>
    </div>
  </div>
  
  <div class="stats-card">
    <h2>Summary ({{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }})</h2>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-title">Total Threads</div>
        <div class="stat-value">{{ total_threads }}</div>
        <div class="stat-meta">{{ new_threads }} new in this period</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">Total Replies</div>
        <div class="stat-value">{{ total_replies }}</div>
        <div class="stat-meta">{{ new_replies }} new in this period</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">Total Activity</div>
        <div class="stat-value">{{ new_threads|add:new_replies }}</div>
        <div class="stat-meta">Threads + Replies this period</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">Active Users</div>
        <div class="stat-value">{{ most_active_users.count }}</div>
        <div class="stat-meta">Users with activity this period</div>
      </div>
    </div>
  </div>
  
  <div class="stats-card">
    <h2>Daily Activity</h2>
    <div class="chart-container">
      <canvas id="activityChart"></canvas>
    </div>
  </div>
  
  <div class="stats-grid">
    <div class="stats-card">
      <h2>Most Active Users</h2>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Threads</th>
              <th>Replies</th>
              <th>Total Activity</th>
            </tr>
          </thead>
          <tbody>
            {% for user in most_active_users %}
            <tr>
              <td>{{ user.user.username }}</td>
              <td>{{ user.thread_count }}</td>
              <td>{{ user.reply_count }}</td>
              <td>{{ user.total_activity }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="stats-card">
      <h2>Popular Topics</h2>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Topic</th>
              <th>Threads</th>
            </tr>
          </thead>
          <tbody>
            {% for topic in popular_topics %}
            <tr>
              <td>{{ topic.name }}</td>
              <td>{{ topic.thread_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Chart data
    const dates = [{% for item in daily_data %}'{{ item.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const threads = [{% for item in daily_data %}{{ item.threads }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const replies = [{% for item in daily_data %}{{ item.replies }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    
    // Create activity chart
    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Threads',
            data: threads,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'Replies',
            data: replies,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}