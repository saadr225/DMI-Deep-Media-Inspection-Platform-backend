{% extends "custom_admin/base.html" %} {% block title %}Forum Tags Management{% endblock %} {% block extrastyle %}
<style>
  .tag-card {
    border-radius: 15px;
    overflow: hidden;
  }

  .form-card {
    border-radius: 15px;
    overflow: hidden;
  }

  .form-label {
    font-weight: 500;
  }

  .form-text {
    font-size: 0.85rem;
    color: #6c757d;
  }

  .badge {
    font-size: 85%;
    font-weight: 500;
  }

  .tag-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.35rem 0.65rem;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  .required-field::after {
    content: "*";
    color: var(--danger);
    margin-left: 0.25rem;
  }

  .color-preview {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: inline-block;
    margin-right: 6px;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Page Heading -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-tags me-2"></i> Forum Tags</h1>
    <div>
      <a href="{% url 'custom_admin_forum' %}" class="btn btn-outline-secondary"> <i class="fas fa-arrow-left me-1"></i> Back to Forum </a>
    </div>
  </div>

  {% if messages %}
  <div class="row mb-4">
    <div class="col-12">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Create New Tag Form Card -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow form-card">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-plus me-1"></i> Create New Tag</h6>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="create" value="1" />

            <div class="mb-3">
              <label for="name" class="form-label required-field">Tag Name</label>
              <input type="text" class="form-control" id="name" name="name" required placeholder="Enter tag name" />
            </div>

            <div class="mb-3">
              <label for="color" class="form-label">Tag Color</label>
              <div class="input-group">
                <input type="color" class="form-control form-control-color" id="color" name="color" value="#3498db" />
                <input type="text" class="form-control" id="color_hex" value="#3498db" placeholder="#3498db" />
              </div>
              <div class="form-text">Select or enter a color for this tag</div>
            </div>

            <div class="mb-3">
              <label>Preview</label>
              <div>
                <span class="tag-badge" id="tag_preview">Tag Preview</span>
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Create Tag</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Tag Management Tips -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-lightbulb me-1"></i> Tag Management Tips</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li class="mb-2">Keep tag names short and specific</li>
            <li class="mb-2">Use contrasting colors for better visibility</li>
            <li class="mb-2">Regularly review tags for redundancy</li>
            <li class="mb-2">Remove unused tags to keep the system clean</li>
            <li>Consider creating a tagging convention</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Tags List Card -->
    <div class="col-lg-8">
      <div class="card shadow tag-card">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-list me-1"></i> Existing Tags</h6>
        </div>
        <div class="card-body">
          {% if tags %}
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Color</th>
                  <th>Threads</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="tags-table-body">
                <!-- Table content will be generated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- This div will contain all modals, generated by JavaScript -->
          <div id="tag-modals-container"></div>

          {% else %}
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="fas fa-tag fa-4x text-muted"></i>
            </div>
            <h4 class="text-muted">No tags created yet</h4>
            <p>Create your first tag to help categorize forum threads.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass tags data to JavaScript -->
<script>
  var tagsData = [
    {% for tag in tags %}
      {
        id: {{ tag.id }},
        name: "{{ tag.name|escapejs }}",
        color: "{{ tag.color|default:'#6c757d'|escapejs }}",
        threadCount: {{ tag.thread_count }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>
{% endblock %} {% block extrascripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize tooltips if Bootstrap 5 is used
    if (typeof bootstrap !== "undefined") {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }

    // Handle color input and preview
    const colorInput = document.getElementById("color");
    const colorHexInput = document.getElementById("color_hex");
    const tagPreview = document.getElementById("tag_preview");

    function updatePreview() {
      const color = colorInput.value;
      colorHexInput.value = color;
      tagPreview.style.backgroundColor = color;

      // Calculate whether to use white or black text
      const r = parseInt(color.substr(1, 2), 16);
      const g = parseInt(color.substr(3, 2), 16);
      const b = parseInt(color.substr(5, 2), 16);
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      tagPreview.style.color = brightness > 128 ? "black" : "white";
    }

    // Initial preview
    updatePreview();

    colorInput.addEventListener("input", updatePreview);
    colorHexInput.addEventListener("input", function () {
      if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        colorInput.value = this.value;
        updatePreview();
      }
    });

    // Generate table rows and modals from tags data
    const tableBody = document.getElementById("tags-table-body");
    const modalsContainer = document.getElementById("tag-modals-container");

    // Only proceed if we have tags data and the container elements
    if (typeof tagsData !== "undefined" && tableBody && modalsContainer) {
      tagsData.forEach(function (tag) {
        // Generate table row
        const row = document.createElement("tr");

        // Name cell
        const nameCell = document.createElement("td");
        nameCell.textContent = tag.name;

        // Color cell with preview
        const colorCell = document.createElement("td");
        colorCell.innerHTML = `
          <div class="d-flex align-items-center">
            <span class="color-preview" style="background-color: ${tag.color}"></span>
            <span>${tag.color}</span>
          </div>
        `;

        // Threads cell
        const threadsCell = document.createElement("td");
        if (tag.threadCount > 0) {
          threadsCell.innerHTML = `
            <a href="{% url 'custom_admin_forum' %}?tag_id=${tag.id}">
              ${tag.threadCount} thread${tag.threadCount !== 1 ? "s" : ""}
            </a>
          `;
        } else {
          threadsCell.innerHTML = '<span class="text-muted">0 threads</span>';
        }

        // Actions cell
        const actionsCell = document.createElement("td");
        actionsCell.innerHTML = `
          <button
            type="button"
            class="btn btn-sm btn-warning me-2"
            data-bs-toggle="modal"
            data-bs-target="#editTagModal${tag.id}"
          >
            <i class="fas fa-edit"></i>
          </button>
          <button
            type="button"
            class="btn btn-sm btn-danger"
            data-bs-toggle="modal"
            data-bs-target="#deleteTagModal${tag.id}"
          >
            <i class="fas fa-trash"></i>
          </button>
        `;

        // Add all cells to the row
        row.appendChild(nameCell);
        row.appendChild(colorCell);
        row.appendChild(threadsCell);
        row.appendChild(actionsCell);

        // Add row to table body
        tableBody.appendChild(row);

        // Generate edit modal
        const editModal = document.createElement("div");
        editModal.className = "modal fade";
        editModal.id = `editTagModal${tag.id}`;
        editModal.setAttribute("tabindex", "-1");
        editModal.setAttribute("aria-labelledby", `editTagModalLabel${tag.id}`);
        editModal.setAttribute("aria-hidden", "true");
        editModal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="update" value="1" />
                <input type="hidden" name="tag_id" value="${tag.id}" />

                <div class="modal-header">
                  <h5 class="modal-title" id="editTagModalLabel${tag.id}">Edit Tag</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Tag Name -->
                  <div class="mb-3">
                    <label for="edit_name${tag.id}" class="form-label required-field">Tag Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="edit_name${tag.id}"
                      name="name"
                      value="${tag.name}"
                      required
                    />
                  </div>

                  <!-- Color -->
                  <div class="mb-3">
                    <label for="edit_color${tag.id}" class="form-label">Tag Color</label>
                    <div class="input-group">
                      <input 
                        type="color" 
                        class="form-control form-control-color" 
                        id="edit_color${tag.id}" 
                        name="color" 
                        value="${tag.color}" 
                      />
                      <input 
                        type="text" 
                        class="form-control" 
                        id="edit_color_hex${tag.id}" 
                        value="${tag.color}" 
                        onchange="document.getElementById('edit_color${tag.id}').value = this.value"
                      />
                    </div>
                  </div>

                  <!-- Preview -->
                  <div class="mb-3">
                    <label>Preview</label>
                    <div>
                      <span 
                        class="tag-badge" 
                        id="edit_tag_preview${tag.id}" 
                        style="background-color: ${tag.color}; color: ${getContrastColor(tag.color)}"
                      >
                        ${tag.name}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;

        // Generate delete modal
        const deleteModal = document.createElement("div");
        deleteModal.className = "modal fade";
        deleteModal.id = `deleteTagModal${tag.id}`;
        deleteModal.setAttribute("tabindex", "-1");
        deleteModal.setAttribute("aria-labelledby", `deleteTagModalLabel${tag.id}`);
        deleteModal.setAttribute("aria-hidden", "true");
        deleteModal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="delete" value="1" />
                <input type="hidden" name="tag_id" value="${tag.id}" />

                <div class="modal-header">
                  <h5 class="modal-title" id="deleteTagModalLabel${tag.id}">Confirm Tag Deletion</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Are you sure you want to delete the tag "<strong>${tag.name}</strong>"?
                  </div>

                  ${
                    tag.threadCount > 0
                      ? `<div class="alert alert-info">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>Note:</strong> This tag is used in ${tag.threadCount} thread${
                          tag.threadCount !== 1 ? "s" : ""
                        }. The tag will be removed from all associated threads.
                      </div>`
                      : `<p>This tag will be permanently removed from the system. This action cannot be undone.</p>`
                  }
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i> Delete Tag
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        // Add modals to container
        modalsContainer.appendChild(editModal);
        modalsContainer.appendChild(deleteModal);

        // Set up edit modal behavior
        document.addEventListener("DOMContentLoaded", function () {
          const editColorInput = document.getElementById(`edit_color${tag.id}`);
          const editColorHexInput = document.getElementById(`edit_color_hex${tag.id}`);
          const editTagPreview = document.getElementById(`edit_tag_preview${tag.id}`);

          if (editColorInput && editColorHexInput && editTagPreview) {
            editColorInput.addEventListener("input", function () {
              const color = this.value;
              editColorHexInput.value = color;
              editTagPreview.style.backgroundColor = color;
              editTagPreview.style.color = getContrastColor(color);
            });
          }
        });
      });
    }

    // Calculate contrasting text color (black or white) based on background
    function getContrastColor(hexColor) {
      // Remove # if present
      hexColor = hexColor.replace("#", "");

      // Convert to RGB
      const r = parseInt(hexColor.substr(0, 2), 16);
      const g = parseInt(hexColor.substr(2, 2), 16);
      const b = parseInt(hexColor.substr(4, 2), 16);

      // Calculate brightness
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;

      // Return black or white based on brightness
      return brightness > 128 ? "black" : "white";
    }
  });
</script>
{% endblock %}
