{% extends "custom_admin/base.html" %} {% block title %}Forum Topics Management{% endblock %} {% block extrastyle %}
<style>
  .topic-card {
    border-radius: 15px;
    overflow: hidden;
  }

  .form-card {
    border-radius: 15px;
    overflow: hidden;
  }

  .form-label {
    font-weight: 500;
  }

  .form-text {
    font-size: 0.85rem;
    color: #6c757d;
  }

  .badge {
    font-size: 85%;
    font-weight: 500;
  }

  .topic-icon {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(46, 204, 113, 0.15);
    border-radius: 8px;
    color: var(--primary);
    margin-right: 0.5rem;
  }

  .required-field::after {
    content: "*";
    color: var(--danger);
    margin-left: 0.25rem;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Page Heading -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-folder me-2"></i> Forum Topics</h1>
    <div>
      <a href="{% url 'custom_admin_forum' %}" class="btn btn-outline-secondary"> <i class="fas fa-arrow-left me-1"></i> Back to Forum </a>
    </div>
  </div>

  {% if messages %}
  <div class="row mb-4">
    <div class="col-12">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Create New Topic Form Card -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow form-card">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-plus me-1"></i> Create New Topic</h6>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="create" value="1" />

            <div class="mb-3">
              <label for="name" class="form-label required-field">Topic Name</label>
              <input type="text" class="form-control" id="name" name="name" required placeholder="Enter topic name" />
            </div>

            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                rows="3"
                placeholder="Enter a brief description of this topic"
              ></textarea>
              <div class="form-text">A short description helps users understand what this topic covers</div>
            </div>

            <div class="mb-3">
              <label for="icon" class="form-label">Icon (FontAwesome)</label>
              <div class="input-group">
                <span class="input-group-text">fa-</span>
                <input type="text" class="form-control" id="icon" name="icon" placeholder="e.g., comments, question, users" />
              </div>
              <div class="form-text">Enter a FontAwesome icon name without the 'fa-' prefix</div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Create Topic</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Forum Management Tips -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-lightbulb me-1"></i> Topic Management Tips</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li class="mb-2">Use clear, descriptive topic names</li>
            <li class="mb-2">Add relevant icons to improve visual recognition</li>
            <li class="mb-2">Keep descriptions concise but informative</li>
            <li class="mb-2">Mark topics inactive instead of deleting when possible</li>
            <li>Review topic organization regularly to maintain relevance</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Topics List Card -->
    <div class="col-lg-8">
      <div class="card shadow topic-card">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-list me-1"></i> Existing Topics</h6>
        </div>
        <div class="card-body">
          {% if topics %}
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Threads</th>
                  <th>Status</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="topics-table-body">
                <!-- Table content will be generated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- This div will contain all modals, generated by JavaScript -->
          <div id="topic-modals-container"></div>

          {% else %}
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="fas fa-folder-open fa-4x text-muted"></i>
            </div>
            <h4 class="text-muted">No topics created yet</h4>
            <p>Create your first topic to help organize forum threads.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass topics data to JavaScript -->
<script>
  var topicsData = [
    {% for topic in topics %}
      {
        id: {{ topic.id }},
        name: "{{ topic.name|escapejs }}",
        description: "{{ topic.description|default:''|escapejs }}",
        icon: "{{ topic.icon|default:''|escapejs }}",
        threadCount: {{ topic.thread_count }},
        isActive: {{ topic.is_active|yesno:"true,false" }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>
{% endblock %} {% block extrascripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize tooltips if Bootstrap 5 is used
    if (typeof bootstrap !== "undefined") {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }

    // Generate table rows and modals from topics data
    const tableBody = document.getElementById("topics-table-body");
    const modalsContainer = document.getElementById("topic-modals-container");

    // Only proceed if we have topics data and the container elements
    if (typeof topicsData !== "undefined" && tableBody && modalsContainer) {
      topicsData.forEach(function (topic) {
        // Generate table row
        const row = document.createElement("tr");

        // Name cell with icon
        const nameCell = document.createElement("td");
        nameCell.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="topic-icon">
              <i class="fas fa-${topic.icon || "folder"}"></i>
            </div>
            <span>${topic.name}</span>
          </div>
        `;

        // Description cell
        const descriptionCell = document.createElement("td");
        if (topic.description) {
          // Truncate to 60 chars
          descriptionCell.textContent = topic.description.length > 60 ? topic.description.substring(0, 57) + "..." : topic.description;
          descriptionCell.title = topic.description; // Full text on hover
        } else {
          descriptionCell.innerHTML = '<span class="text-muted">No description</span>';
        }

        // Threads cell
        const threadsCell = document.createElement("td");
        if (topic.threadCount > 0) {
          threadsCell.innerHTML = `
            <a href="{% url 'custom_admin_forum' %}?topic_id=${topic.id}">
              ${topic.threadCount} thread${topic.threadCount !== 1 ? "s" : ""}
            </a>
          `;
        } else {
          threadsCell.innerHTML = '<span class="text-muted">0 threads</span>';
        }

        // Status cell
        const statusCell = document.createElement("td");
        statusCell.innerHTML = `
          <span class="badge bg-${topic.isActive ? "success" : "danger"}">
            ${topic.isActive ? "Active" : "Inactive"}
          </span>
        `;

        // Actions cell
        const actionsCell = document.createElement("td");
        actionsCell.innerHTML = `
          <button
            type="button"
            class="btn btn-sm btn-warning me-2"
            data-bs-toggle="modal"
            data-bs-target="#editTopicModal${topic.id}"
          >
            <i class="fas fa-edit"></i>
          </button>
          <button
            type="button"
            class="btn btn-sm btn-danger"
            data-bs-toggle="modal"
            data-bs-target="#deleteTopicModal${topic.id}"
          >
            <i class="fas fa-trash"></i>
          </button>
        `;

        // Add all cells to the row
        row.appendChild(nameCell);
        row.appendChild(descriptionCell);
        row.appendChild(threadsCell);
        row.appendChild(statusCell);
        row.appendChild(actionsCell);

        // Add row to table body
        tableBody.appendChild(row);

        // Generate edit modal
        const editModal = document.createElement("div");
        editModal.className = "modal fade";
        editModal.id = `editTopicModal${topic.id}`;
        editModal.setAttribute("tabindex", "-1");
        editModal.setAttribute("aria-labelledby", `editTopicModalLabel${topic.id}`);
        editModal.setAttribute("aria-hidden", "true");
        editModal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="update" value="1" />
                <input type="hidden" name="topic_id" value="${topic.id}" />

                <div class="modal-header">
                  <h5 class="modal-title" id="editTopicModalLabel${topic.id}">Edit Topic</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Topic Name -->
                  <div class="mb-3">
                    <label for="edit_name${topic.id}" class="form-label required-field">Topic Name</label>
                    <input
                      type="text"
                      class="form-control"
                      id="edit_name${topic.id}"
                      name="name"
                      value="${topic.name}"
                      required
                    />
                  </div>

                  <!-- Description -->
                  <div class="mb-3">
                    <label for="edit_description${topic.id}" class="form-label">Description</label>
                    <textarea class="form-control" id="edit_description${topic.id}" name="description" rows="3">${
          topic.description
        }</textarea>
                  </div>

                  <!-- Icon -->
                  <div class="mb-3">
                    <label for="edit_icon${topic.id}" class="form-label">Icon (FontAwesome)</label>
                    <div class="input-group">
                      <span class="input-group-text">fa-</span>
                      <input type="text" class="form-control" id="edit_icon${topic.id}" name="icon" value="${topic.icon}" />
                    </div>
                    <div class="form-text">Enter a FontAwesome icon name without the 'fa-' prefix</div>
                  </div>

                  <!-- Active Switch -->
                  <div class="form-check form-switch mb-3">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="is_active${topic.id}"
                      name="is_active"
                      ${topic.isActive ? "checked" : ""}
                    />
                    <label class="form-check-label" for="is_active${topic.id}">Active</label>
                    <div class="form-text">Inactive topics won't appear in the frontend selection</div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;

        // Generate delete modal
        const deleteModal = document.createElement("div");
        deleteModal.className = "modal fade";
        deleteModal.id = `deleteTopicModal${topic.id}`;
        deleteModal.setAttribute("tabindex", "-1");
        deleteModal.setAttribute("aria-labelledby", `deleteTopicModalLabel${topic.id}`);
        deleteModal.setAttribute("aria-hidden", "true");
        deleteModal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="delete" value="1" />
                <input type="hidden" name="topic_id" value="${topic.id}" />

                <div class="modal-header">
                  <h5 class="modal-title" id="deleteTopicModalLabel${topic.id}">Confirm Topic Deletion</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Are you sure you want to delete the topic "<strong>${topic.name}</strong>"?
                  </div>

                  ${
                    topic.threadCount > 0
                      ? `<div class="alert alert-danger">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>Important:</strong> This topic has ${topic.threadCount} thread${
                          topic.threadCount !== 1 ? "s" : ""
                        } associated with it.
                      <hr />
                      <p class="mb-0">
                        Instead of deleting, we'll mark it as <strong>inactive</strong> to prevent issues with existing threads.
                      </p>
                    </div>`
                      : `<p>This topic will be permanently removed from the system. This action cannot be undone.</p>`
                  }
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button
                    type="submit"
                    class="btn btn-danger"
                  >
                    ${
                      topic.threadCount > 0
                        ? '<i class="fas fa-ban me-1"></i> Make Inactive'
                        : '<i class="fas fa-trash me-1"></i> Delete Topic'
                    }
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        // Add modals to container
        modalsContainer.appendChild(editModal);
        modalsContainer.appendChild(deleteModal);
      });
    }
  });
</script>
{% endblock %}
