{% extends "moderation/base.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block extrastyle %}
<style>
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 30px;
    }
    .metric-card {
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: transform 0.3s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0;
    }
    .metric-label {
        color: #4e73df;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
        margin-bottom: 5px;
    }
    .metric-change {
        font-size: 0.9rem;
    }
    .positive-change {
        color: #1cc88a;
    }
    .negative-change {
        color: #e74a3b;
    }
    .neutral-change {
        color: #858796;
    }
    .filter-form {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fc;
        border-radius: 8px;
    }
    .section-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: #4e73df;
        border-bottom: 2px solid #e3e6f0;
        padding-bottom: 10px;
    }
    .table-container {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    .bg-gradient-primary-to-secondary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
    }
    .bg-gradient-success-to-secondary {
        background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        color: white;
    }
    .bg-gradient-info-to-secondary {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        color: white;
    }
    .bg-gradient-warning-to-secondary {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Platform Analytics Dashboard</h1>
    <div class="filter-form d-flex">
        <form method="get" class="d-flex align-items-center">
            <label class="me-2">Time Range:</label>
            <select name="days" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 months</option>
                <option value="365" {% if days == 365 %}selected{% endif %}>Last year</option>
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Apply</button>
        </form>
    </div>
</div>

<!-- Content Row - Main Metrics -->
<div class="row">
    <!-- User Metrics -->
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-gradient-primary-to-secondary">
            <div class="metric-label">Total Users</div>
            <div class="metric-value">{{ total_users }}</div>
            <div class="metric-change {% if new_users > 0 %}positive-change{% else %}neutral-change{% endif %}">
                <i class="fas {% if new_users > 0 %}fa-arrow-up{% else %}fa-equals{% endif %} me-1"></i>
                {{ new_users }} new in last {{ days }} days
            </div>
        </div>
    </div>

    <!-- Forum Metrics -->
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-gradient-success-to-secondary">
            <div class="metric-label">Forum Threads</div>
            <div class="metric-value">{{ total_threads }}</div>
            <div class="metric-change {% if new_threads > 0 %}positive-change{% else %}neutral-change{% endif %}">
                <i class="fas {% if new_threads > 0 %}fa-arrow-up{% else %}fa-equals{% endif %} me-1"></i>
                {{ new_threads }} new in last {{ days }} days
            </div>
        </div>
    </div>

    <!-- PDA Metrics -->
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-gradient-info-to-secondary">
            <div class="metric-label">PDA Submissions</div>
            <div class="metric-value">{{ total_pda }}</div>
            <div class="metric-change {% if new_pda > 0 %}positive-change{% else %}neutral-change{% endif %}">
                <i class="fas {% if new_pda > 0 %}fa-arrow-up{% else %}fa-equals{% endif %} me-1"></i>
                {{ new_pda }} new in last {{ days }} days
            </div>
        </div>
    </div>

    <!-- Reply Metrics -->
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-gradient-warning-to-secondary">
            <div class="metric-label">Forum Replies</div>
            <div class="metric-value">{{ total_replies }}</div>
            <div class="metric-change {% if new_replies > 0 %}positive-change{% else %}neutral-change{% endif %}">
                <i class="fas {% if new_replies > 0 %}fa-arrow-up{% else %}fa-equals{% endif %} me-1"></i>
                {{ new_replies }} new in last {{ days }} days
            </div>
        </div>
    </div>
</div>

<!-- Content Row - Charts -->
<div class="row">
    <!-- Activity Timeline Chart -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Activity Timeline</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityTimelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Status Distribution -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Content Status</h6>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 200px">
                    <canvas id="approvalStatusChart"></canvas>
                </div>
                <hr>
                <div class="chart-container" style="height: 200px">
                    <canvas id="pdaStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Row - Tables -->
<div class="row">
    <!-- Popular Topics Table -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Popular Topics</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Threads</th>
                                <th>Engagement</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for topic in popular_topics %}
                            <tr>
                                <td>{{ topic.name }}</td>
                                <td>{{ topic.thread_count }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                            style="width: {{ topic.thread_count|default:0|floatformat:0 }}%"
                                            aria-valuenow="{{ topic.thread_count|default:0|floatformat:0 }}" 
                                            aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No topics found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Statistics -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">User Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card text-center">
                            <div class="metric-label">Verified Users</div>
                            <div class="metric-value">{{ verified_users }}</div>
                            <div class="metric-change">
                                {{ verified_users|floatformat:1 }}% of total users
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card text-center">
                            <div class="metric-label">New Users ({{ days }} days)</div>
                            <div class="metric-value">{{ new_users }}</div>
                            <div class="metric-change">
                                {{ new_users|floatformat:1 }}% growth
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container mt-4" style="height: 250px">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Moderation Activity -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Moderation Activity</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="metric-card text-center">
                            <div class="metric-label">PDA Approval Rate</div>
                            <div class="metric-value">
                                {% if approved_pda > 0 and total_pda > 0 %}
                                    {{ approved_pda|floatformat:1 }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card text-center">
                            <div class="metric-label">PDA Rejection Rate</div>
                            <div class="metric-value">
                                {% if rejected_pda > 0 and total_pda > 0 %}
                                    {{ rejected_pda|floatformat:1 }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card text-center">
                            <div class="metric-label">Thread Approval Rate</div>
                            <div class="metric-value">
                                {% for status in threads_by_status %}
                                    {% if status.approval_status == 'approved' %}
                                        {% if status.count > 0 and total_threads > 0 %}
                                            {{ status.count|floatformat:1 }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card text-center">
                            <div class="metric-label">Avg. Response Time</div>
                            <div class="metric-value">24h</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Activity Timeline Chart
    const timelineCtx = document.getElementById('activityTimelineChart').getContext('2d');
    const timelineData = {
        labels: [{% for item in timeline_data %}'{{ item.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'New Threads',
            data: [{% for item in timeline_data %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            borderWidth: 2,
            pointBackgroundColor: '#4e73df',
            tension: 0.3,
            fill: true
        }]
    };
    new Chart(timelineCtx, {
        type: 'line',
        data: timelineData,
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    // Approval Status Chart (Forum)
    const statusCtx = document.getElementById('approvalStatusChart').getContext('2d');
    let approvedCount = 0, pendingCount = 0, rejectedCount = 0;
    
    {% for status in threads_by_status %}
        {% if status.approval_status == 'approved' %}
            approvedCount = {{ status.count }};
        {% elif status.approval_status == 'pending' %}
            pendingCount = {{ status.count }};
        {% elif status.approval_status == 'rejected' %}
            rejectedCount = {{ status.count }};
        {% endif %}
    {% endfor %}
    
    const statusData = {
        labels: ['Approved', 'Pending', 'Rejected'],
        datasets: [{
            data: [approvedCount, pendingCount, rejectedCount],
            backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
            hoverBackgroundColor: ['#169969', '#dda20a', '#be3c2d'],
            hoverBorderColor: 'rgba(234, 236, 244, 1)',
        }]
    };
    new Chart(statusCtx, {
        type: 'doughnut',
        data: statusData,
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                title: {
                    display: true,
                    text: 'Forum Thread Status'
                }
            },
            cutout: '70%'
        }
    });
    
    // PDA Status Chart
    const pdaCtx = document.getElementById('pdaStatusChart').getContext('2d');
    const pdaData = {
        labels: ['Approved', 'Pending', 'Rejected'],
        datasets: [{
            data: [{{ approved_pda }}, {{ pending_pda }}, {{ rejected_pda }}],
            backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
            hoverBackgroundColor: ['#169969', '#dda20a', '#be3c2d'],
            hoverBorderColor: 'rgba(234, 236, 244, 1)',
        }]
    };
    new Chart(pdaCtx, {
        type: 'doughnut',
        data: pdaData,
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                title: {
                    display: true,
                    text: 'PDA Submission Status'
                }
            },
            cutout: '70%'
        }
    });
    
    // User Activity Chart
    const userCtx = document.getElementById('userActivityChart').getContext('2d');
    const userData = {
        labels: ['Threads Created', 'Replies Posted', 'PDA Submissions'],
        datasets: [{
            label: 'Last {{ days }} Days',
            data: [{{ new_threads }}, {{ new_replies }}, {{ new_pda }}],
            backgroundColor: [
                'rgba(78, 115, 223, 0.8)',
                'rgba(28, 200, 138, 0.8)',
                'rgba(54, 185, 204, 0.8)'
            ],
            borderWidth: 1
        }]
    };
    new Chart(userCtx, {
        type: 'bar',
        data: userData,
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %} 